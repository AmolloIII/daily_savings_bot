name: Friday Savings Email

on:
  workflow_dispatch:
    inputs:
      send_emails:
        description: 'Send emails (true/false)'
        required: false
        default: false
        type: boolean
  schedule:
    - cron: '0 16 * * 5'  # Friday 7 PM Kenya time = 16:00 UTC (Friday)

jobs:
  run-friday-email:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev \
            libfontconfig1-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libfreetype6-dev \
            libpng-dev \
            libtiff5-dev \
            libjpeg-dev \
            libgomp1 \
            libicu-dev \
            libpcre2-dev

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.2'

      - name: Install R packages (with specific versions)
        run: |
          R -e "
          # Install packages with specific versions for stability
          install.packages('remotes')
          install.packages('curl', version = '5.2.0', repos = 'https://cloud.r-project.org')
          install.packages('httr', version = '1.4.7', repos = 'https://cloud.r-project.org')
          install.packages(c(
            'dplyr',
            'lubridate',
            'tidyr',
            'googlesheets4',
            'gargle',
            'glue',
            'gt',
            'rlang',
            'xml2',
            'openssl'
          ), repos = 'https://cloud.r-project.org')
          
          # Install blastula from GitHub (more stable version)
          remotes::install_github('rstudio/blastula')
          "
          
      - name: Write Google credentials
        run: |
          echo "${{ secrets.GSHEET_JSON_B64 }}" | base64 --decode > gs.json
          
      - name: Run Friday Savings Email (with retry)
        run: |
          echo "GitHub Event: ${{ github.event_name }}"
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.send_emails }}" == "true" ]]; then
            echo "üöÄ Running with email sending enabled (manual trigger)"
            
            # Run with error handling and retry
            for attempt in {1..3}; do
              echo "Attempt $attempt of 3..."
              if Rscript friday_savings_email.R --send; then
                echo "‚úÖ Script completed successfully"
                break
              else
                echo "‚ö†Ô∏è Script failed, attempt $attempt"
                if [ $attempt -lt 3 ]; then
                  echo "Waiting 10 seconds before retry..."
                  sleep 10
                else
                  echo "‚ùå All attempts failed"
                  exit 1
                fi
              fi
            done
            
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "‚è∞ Running with email sending enabled (scheduled run)"
            Rscript friday_savings_email.R --send
          else
            echo "üíæ Running in file save mode (dry run)"
            Rscript friday_savings_email.R
          fi
        env:
          GSHEET_JSON_B64: ${{ secrets.GSHEET_JSON_B64 }}
          MY_GMAIL_ACCOUNT: ${{ secrets.MY_GMAIL_ACCOUNT }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          
      - name: Check for segmentation faults
        if: always()
        run: |
          if [ -f core.* ]; then
            echo "‚ö†Ô∏è Segmentation fault core dump found"
            echo "This indicates a serious error in the R/C libraries"
          fi
